-- çš®ç©ºAPIç¿»è¯‘ - å®Œæ•´ç‹¬ç«‹ç‰ˆ
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

-- ä¸»è„šæœ¬åˆå§‹åŒ–å‡½æ•°
function initTranslationScript()
    -- ä½¿ç”¨WindUIåº“
    local success, WindUI = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/Xingyan777/roblox/refs/heads/main/main.lua"))()
    end)
    
    if not success then
        -- å¤‡ç”¨ç®€å•UI
        local message = Instance.new("Message")
        message.Text = "çš®ç©ºAPIç¿»è¯‘ - WindUIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
        message.Parent = workspace
        wait(3)
        message:Destroy()
        return
    end

    -- æ˜¾ç¤ºæ¬¢è¿é€šçŸ¥
    WindUI:Notify({
        Title = "çš®ç©ºAPIç¿»è¯‘",
        Content = "é«˜çº§å¤šAPIç¿»è¯‘ç³»ç»Ÿå·²åŠ è½½",
        Duration = 4
    })

    local Confirmed = false

    -- æ¬¢è¿å¼¹çª—
    WindUI:Popup({
        Title = "çš®ç©ºAPIç¿»è¯‘",
        IconThemed = true,
        Content = "å¤šAPIæ”¯æŒçš„æ™ºèƒ½ç¿»è¯‘ç³»ç»Ÿ\näº«å—æ— ç¼çš„ç•Œé¢æ±‰åŒ–ä½“éªŒ",
        Theme = "Light",
        Buttons = {
            {
                Title = "é€€å‡º",
                Callback = function() 
                    return
                end,
                Variant = "Secondary",
            },
            {
                Title = "å¼€å§‹ä½¿ç”¨",
                Icon = "arrow-right",
                Callback = function() 
                    Confirmed = true 
                end,
                Variant = "Primary",
            }
        }
    })

    repeat wait() until Confirmed

    -- åˆ›å»ºä¸»çª—å£
    local Window = WindUI:CreateWindow({
        Title = "çš®ç©ºAPIç¿»è¯‘",
        Icon = "rbxassetid://4483362748",
        IconThemed = true,
        Folder = "çš®ç©ºç¿»è¯‘",
        Size = UDim2.fromOffset(620, 450),
        Transparent = true,
        Theme = "Light",
        User = { 
            Enabled = true,
            Image = "https://c-ssl.duitang.com/uploads/blog/202103/27/20210327131203_74b6b.jpg"
        },
        SideBarWidth = 200,
        ScrollBarEnabled = true,
    })

    -- æ·»åŠ æ ‡ç­¾
    Window:Tag({
        Title = "çš®ç©ºAPIç¿»è¯‘",
        Color = Color3.fromHex("#FF6B6B")
    })

    -- åˆ›å»ºæ ‡ç­¾é¡µç»“æ„
    local Tabs = {}

    -- ä¸»åŠŸèƒ½éƒ¨åˆ†
    Tabs.MainSection = Window:Section({
        Title = "ç¿»è¯‘æ§åˆ¶",
        Icon = "languages",
        Opened = true,
    })

    Tabs.ConfigSection = Window:Section({
        Title = "APIè®¾ç½®",
        Opened = true,
    })

    Tabs.AdvancedSection = Window:Section({
        Title = "é«˜çº§åŠŸèƒ½",
        Opened = true,
    })

    Tabs.InfoSection = Window:Section({
        Title = "ç³»ç»Ÿä¿¡æ¯",
        Opened = true,
    })

    -- åˆ›å»ºæ ‡ç­¾é¡µ
    Tabs.MainTab = Tabs.MainSection:Tab({ Title = "ç¿»è¯‘æ§åˆ¶", Icon = "play" })
    Tabs.ConfigTab = Tabs.ConfigSection:Tab({ Title = "APIè®¾ç½®", Icon = "settings" })
    Tabs.AdvancedTab = Tabs.AdvancedSection:Tab({ Title = "é«˜çº§åŠŸèƒ½", Icon = "zap" })
    Tabs.InfoTab = Tabs.InfoSection:Tab({ Title = "ç³»ç»Ÿä¿¡æ¯", Icon = "info" })

    Window:SelectTab(1)

    -- ========== ç¿»è¯‘å¼•æ“åˆå§‹åŒ– ==========
    local LocalPlayer = Players.LocalPlayer
    if not LocalPlayer then
        LocalPlayer = Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    end

    local MY_NAMESPACE = "çš®ç©ºç¿»è¯‘_" .. tostring(math.random(10000, 99999))
    if not _G[MY_NAMESPACE] then
        _G[MY_NAMESPACE] = {
            textData = {},
            scannedElements = {},
            translatedElements = {},
            monitorConnections = {},
            translateQueue = {},
            queuedSet = {},
            isProcessingQueue = false,
            isRunning = false,
            extractCount = 0,
            translateCount = 0,
            localizeCount = 0,
            cache = {},
            lastScanTime = 0,
            totalElementsScanned = 0
        }
    end
    local Engine = _G[MY_NAMESPACE]

    -- è¿è¡Œæ—¶é…ç½®
    local RUNTIME = {
        translationAPI = "Google",
        customAPIUrl = "",
        translationsPerSecond = 25,
        batchSize = 8,
        concurrencyLimit = 6,
        scanInterval = 3,
        minTextLength = 1,
        maxTextLength = 150,
        CACHE_ENABLED = true,
        CACHE_FILE = "çš®ç©ºç¿»è¯‘ç¼“å­˜.json",
        autoStart = false,
        smartDetection = true,
        excludeChinese = true
    }

    -- æ–‡ä»¶æ“ä½œå‡½æ•°
    local readFunc, writeFunc
    pcall(function()
        if type(syn) == "table" then
            readFunc = syn.readfile or readfile
            writeFunc = syn.writefile or writefile
        else
            readFunc = readfile
            writeFunc = writefile
        end
    end)

    local function getVerifyFolderPath()
        local basePath = "Roblox/Scripts"
        local folderPath = basePath .. "/çš®ç©ºç¿»è¯‘"
        return folderPath
    end

    -- ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨
    pcall(function()
        if not isfolder("Roblox") then
            makefolder("Roblox")
        end
        if not isfolder("Roblox/Scripts") then
            makefolder("Roblox/Scripts")
        end
        if not isfolder(getVerifyFolderPath()) then
            makefolder(getVerifyFolderPath())
        end
    end)

    -- ç¼“å­˜å‡½æ•°
    local function loadCacheFromFile()
        if not RUNTIME.CACHE_ENABLED then return end
        if type(readFunc) ~= "function" then return end
        
        local filePath = getVerifyFolderPath() .. "/" .. RUNTIME.CACHE_FILE
        if not isfile(filePath) then return end
        
        local ok, content = pcall(function() 
            return readFunc(filePath) 
        end)
        
        if ok and content and content ~= "" then
            local suc, data = pcall(function() 
                return HttpService:JSONDecode(content) 
            end)
            if suc and type(data) == "table" then
                Engine.cache = data
                for k,v in pairs(data) do
                    Engine.textData[k] = Engine.textData[k] or { 
                        translation = v, 
                        paths = {}, 
                        translated = v ~= "" 
                    }
                end
                print("çš®ç©ºç¿»è¯‘ - ç¼“å­˜åŠ è½½æˆåŠŸï¼Œå…± " .. #data .. " æ¡è®°å½•")
            end
        end
    end

    local function saveCacheToFile()
        if not RUNTIME.CACHE_ENABLED then return end
        if type(writeFunc) ~= "function" then return end
        
        local ok, json = pcall(function() 
            return HttpService:JSONEncode(Engine.cache or {}) 
        end)
        
        if ok and json then
            pcall(function() 
                writeFunc(getVerifyFolderPath() .. "/" .. RUNTIME.CACHE_FILE, json) 
            end)
        end
    end

    local function clearCache()
        Engine.cache = {}
        Engine.textData = {}
        if type(writeFunc) == "function" then
            pcall(function() 
                writeFunc(getVerifyFolderPath() .. "/" .. RUNTIME.CACHE_FILE, "{}") 
            end)
        end
        WindUI:Notify({
            Title = "çš®ç©ºç¿»è¯‘",
            Content = "ç¿»è¯‘ç¼“å­˜å·²æ¸…ç©º",
            Duration = 3
        })
    end

    -- æ–‡æœ¬è¿‡æ»¤
    local function shouldFilterText(text)
        if not text or text:gsub("%s+", "") == "" then return true end
        if text:match("^[%p%s]+$") then return true end
        if #text < RUNTIME.minTextLength then return true end
        if #text > RUNTIME.maxTextLength then return true end
        
        -- æ’é™¤ä¸­æ–‡æ–‡æœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if RUNTIME.excludeChinese and text:match("[\228-\233][\128-\191].") then
            return true
        end
        
        return false
    end

    -- å¤šç¿»è¯‘APIæ”¯æŒ
    local function translateWithGoogle(orig)
        local url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=" .. HttpService:UrlEncode(orig)
        
        local ok, body = pcall(function()
            return game:HttpGet(url, true, {["User-Agent"] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"})
        end)
        
        if not ok or not body then 
            return "" 
        end
        
        local parsedOk, parsed = pcall(function() 
            return HttpService:JSONDecode(body) 
        end)
        
        if not parsedOk or type(parsed) ~= "table" or type(parsed[1]) ~= "table" then
            return ""
        end
        
        local parts = {}
        for _, seg in ipairs(parsed[1]) do
            if type(seg) == "table" and seg[1] then 
                table.insert(parts, tostring(seg[1])) 
            end
        end
        
        local result = table.concat(parts)
        return result ~= orig and result or ""
    end

    local function translateWithBaidu(orig)
        -- ç™¾åº¦ç¿»è¯‘APIå®ç°
        local appid = "your_appid"  -- éœ€è¦ç”¨æˆ·è‡ªå·±å¡«å†™
        local key = "your_key"      -- éœ€è¦ç”¨æˆ·è‡ªå·±å¡«å†™
        local salt = tostring(math.random(10000, 99999))
        local sign = appid .. orig .. salt .. key
        
        -- è¿™é‡Œéœ€è¦MD5è®¡ç®—ï¼Œç®€åŒ–å¤„ç†
        return "" -- éœ€è¦å®Œæ•´å®ç°
    end

    local function translateWithTencent(orig)
        -- è…¾è®¯ç¿»è¯‘APIå®ç°
        return "" -- éœ€è¦å®Œæ•´å®ç°
    end

    local function translateWithCustom(orig)
        if RUNTIME.customAPIUrl == "" then return "" end
        
        local url = RUNTIME.customAPIUrl:gsub("{text}", HttpService:UrlEncode(orig))
        local ok, body = pcall(function()
            return game:HttpGet(url, true, {["User-Agent"] = "Mozilla/5.0"})
        end)
        
        if ok and body then
            return body
        end
        
        return ""
    end

    local function translateText(orig)
        if not orig or orig == "" then return "" end
        
        -- æ£€æŸ¥ç¼“å­˜
        if Engine.textData[orig] and Engine.textData[orig].translation and Engine.textData[orig].translation ~= "" then
            return Engine.textData[orig].translation
        end
        
        if RUNTIME.CACHE_ENABLED and Engine.cache and Engine.cache[orig] then
            Engine.textData[orig] = Engine.textData[orig] or { 
                translation = Engine.cache[orig], 
                paths = {}, 
                translated = true 
            }
            return Engine.cache[orig]
        end

        local translation = ""
        
        -- æ ¹æ®é€‰æ‹©çš„APIè¿›è¡Œç¿»è¯‘
        if RUNTIME.translationAPI == "Google" then
            translation = translateWithGoogle(orig)
        elseif RUNTIME.translationAPI == "Baidu" then
            translation = translateWithBaidu(orig)
        elseif RUNTIME.translationAPI == "Tencent" then
            translation = translateWithTencent(orig)
        elseif RUNTIME.translationAPI == "Custom" then
            translation = translateWithCustom(orig)
        end

        if translation ~= "" and translation ~= orig then
            Engine.textData[orig] = Engine.textData[orig] or { 
                translation = "", 
                paths = {}, 
                translated = false 
            }
            Engine.textData[orig].translation = translation
            Engine.textData[orig].translated = true
            Engine.translateCount = Engine.translateCount + 1
            
            if RUNTIME.CACHE_ENABLED then
                Engine.cache[orig] = translation
                spawn(saveCacheToFile)
            end
        end
        
        return translation
    end

    -- é˜Ÿåˆ—ç®¡ç†
    local function enqueueText(text)
        if not text or shouldFilterText(text) then return end
        if Engine.queuedSet[text] or (Engine.textData[text] and Engine.textData[text].translated) then return end
        
        table.insert(Engine.translateQueue, { text = text, priority = #text })
        Engine.queuedSet[text] = true
    end

    -- å¢å¼ºç‰ˆGUIè·å–å‡½æ•°
    local function gethui_enhanced()
        local guis = {}
        
        -- å°è¯•å„ç§è·å–GUIçš„æ–¹æ³•
        if type(gethui) == "function" then
            local success, result = pcall(gethui)
            if success and result then
                table.insert(guis, result)
            end
        end
        
        local aliases = {"get_hui", "get_container", "get_roblox_gui", "_x92a", "get_gui"}
        for _, alias in ipairs(aliases) do
            if type(_G[alias]) == "function" then
                local success, result = pcall(_G[alias])
                if success and result then
                    table.insert(guis, result)
                end
            end
        end
        
        -- æ·»åŠ æ ‡å‡†GUIå®¹å™¨
        local success, result = pcall(function()
            return game:GetService("CoreGui")
        end)
        if success and result then
            table.insert(guis, result)
        end
        
        local localPlayer = Players.LocalPlayer
        if localPlayer then
            local playerGui = localPlayer:FindFirstChildOfClass("PlayerGui")
            if playerGui then
                table.insert(guis, playerGui)
            end
            
            -- æ·»åŠ å…¶ä»–å¯èƒ½çš„GUIå®¹å™¨
            local backpack = localPlayer:FindFirstChildOfClass("Backpack")
            if backpack then
                table.insert(guis, backpack)
            end
        end
        
        -- æ‰«æCoreGuiä¸­çš„ç‰¹æ®ŠGUI
        for _, obj in ipairs(CoreGui:GetDescendants()) do
            if obj:IsA("ScreenGui") then
                if obj.Name:find("Remote") or obj.Name:find("Gui") or obj.Name:find("Interface") then
                    table.insert(guis, obj.Parent)
                end
            end
        end
        
        -- æ·»åŠ å¸¸è§çš„æ‰§è¡Œå™¨GUI
        for _, obj in ipairs(CoreGui:GetDescendants()) do
            if obj:IsA("ScreenGui") then
                if obj.Name == "Synapse" or obj.Name == "Krnl" or obj.Name == "ScriptWare" or obj.Name == "Fluxus" then
                    table.insert(guis, obj.Parent)
                end
            end
        end
        
        local uniqueGuis = {}
        for _, gui in ipairs(guis) do
            if gui and not table.find(uniqueGuis, gui) then
                table.insert(uniqueGuis, gui)
            end
        end
        
        return uniqueGuis
    end

    -- æ–‡æœ¬æå–
    local function extractElementText(element)
        if not element then return end
        if not (element:IsA("TextLabel") or element:IsA("TextButton") or element:IsA("TextBox")) then return end
        if Engine.scannedElements[element] then return end
        
        local ok, txt = pcall(function() return element.Text end)
        if not ok or not txt then
            Engine.scannedElements[element] = true
            return
        end
        
        local text = tostring(txt)
        if shouldFilterText(text) then
            Engine.scannedElements[element] = true
            return
        end
        
        local path = tostring(element)
        if not Engine.textData[text] then
            Engine.textData[text] = { 
                translation = "", 
                paths = { path }, 
                translated = false 
            }
            Engine.extractCount = Engine.extractCount + 1
            enqueueText(text)
        else
            local paths = Engine.textData[text].paths or {}
            if not table.find(paths, path) then 
                table.insert(paths, path) 
                Engine.textData[text].paths = paths 
            end
        end
        
        Engine.scannedElements[element] = true
    end

    -- ç›‘æ§å…ƒç´ 
    local function setupElementMonitor(element)
        if not element then return end
        if Engine.translatedElements[element] then return end
        
        local ok, textConn = pcall(function()
            return element:GetPropertyChangedSignal("Text"):Connect(function()
                task.wait(0.05)
                extractElementText(element)
            end)
        end)
        if ok and textConn then 
            table.insert(Engine.monitorConnections, textConn) 
        end
        
        -- ç›‘æ§é¼ æ ‡æ‚¬åœäº‹ä»¶
        if element:IsA("TextButton") or element:IsA("TextLabel") then
            local ok2, conn = pcall(function()
                return element.MouseEnter:Connect(function()
                    task.wait(0.1)
                    extractElementText(element)
                end)
            end)
            if ok2 and conn then 
                table.insert(Engine.monitorConnections, conn) 
            end
        end
    end

    -- æ‰«ææ‰€æœ‰GUIå…ƒç´ 
    local function scanAllGuiElements()
        local guis = gethui_enhanced()
        local totalElements = 0
        local newTexts = 0
        
        for _, container in ipairs(guis) do
            if not container then continue end
            
            local descendants = {}
            pcall(function()
                descendants = container:GetDescendants()
            end)
            
            for i, desc in ipairs(descendants) do
                if desc and (desc:IsA("TextLabel") or desc:IsA("TextButton") or desc:IsA("TextBox")) then
                    local beforeCount = Engine.extractCount
                    extractElementText(desc)
                    setupElementMonitor(desc)
                    totalElements = totalElements + 1
                    
                    if Engine.extractCount > beforeCount then
                        newTexts = newTexts + 1
                    end
                end
                
                -- æ€§èƒ½ä¼˜åŒ–ï¼šæ¯100ä¸ªå…ƒç´ æš‚åœä¸€ä¸‹
                if i % 100 == 0 then
                    task.wait(0.01)
                end
            end
            
            -- ç›‘æ§æ–°æ·»åŠ çš„å…ƒç´ 
            local ok, conn = pcall(function()
                return container.DescendantAdded:Connect(function(desc)
                    if desc and (desc:IsA("TextLabel") or desc:IsA("TextButton") or desc:IsA("TextBox")) then
                        task.wait(0.05)
                        extractElementText(desc)
                        setupElementMonitor(desc)
                    end
                end)
            end)
            if ok and conn then
                table.insert(Engine.monitorConnections, conn)
            end
        end
        
        Engine.totalElementsScanned = Engine.totalElementsScanned + totalElements
        Engine.lastScanTime = os.time()
        
        WindUI:Notify({
            Title = "çš®ç©ºç¿»è¯‘",
            Content = string.format("æ‰«æå®Œæˆï¼æ‰«æäº† %d ä¸ªå…ƒç´ ï¼Œå‘ç° %d ä¸ªæ–°æ–‡æœ¬", totalElements, newTexts),
            Duration = 3
        })
        
        return totalElements, newTexts
    end

    -- ç¿»è¯‘å¤„ç†å¾ªç¯
    local function processTranslationQueue()
        while Engine.isRunning and #Engine.translateQueue > 0 do
            local batch = {}
            for i = 1, math.min(RUNTIME.batchSize, #Engine.translateQueue) do
                local item = table.remove(Engine.translateQueue, 1)
                if item then
                    table.insert(batch, item)
                    Engine.queuedSet[item.text] = nil
                end
            end
            
            local translatedInBatch = 0
            for _, item in ipairs(batch) do
                spawn(function()
                    local translation = translateText(item.text)
                    if translation and translation ~= "" then
                        if Engine.textData[item.text] then
                            Engine.textData[item.text].translated = true
                        end
                        translatedInBatch = translatedInBatch + 1
                    end
                end)
            end
            
            if translatedInBatch > 0 then
                print(string.format("çš®ç©ºç¿»è¯‘ - æ‰¹é‡ç¿»è¯‘äº† %d ä¸ªæ–‡æœ¬", translatedInBatch))
            end
            
            task.wait(1.0 / RUNTIME.translationsPerSecond)
        end
    end

    -- æœ¬åœ°åŒ–åº”ç”¨
    local function applyLocalizations()
        while Engine.isRunning do
            local guis = gethui_enhanced()
            local localizedCount = 0
            
            for _, container in ipairs(guis) do
                if not container then continue end
                
                local descendants = {}
                pcall(function()
                    descendants = container:GetDescendants()
                end)
                
                for _, desc in ipairs(descendants) do
                    if desc and (desc:IsA("TextLabel") or desc:IsA("TextButton") or desc:IsA("TextBox")) then
                        if Engine.translatedElements[desc] then continue end
                        
                        local ok, text = pcall(function() return desc.Text end)
                        if not ok or not text then continue end
                        
                        local origText = tostring(text)
                        local data = Engine.textData[origText]
                        
                        if data and data.translation and data.translation ~= "" and data.translation ~= origText then
                            local success = pcall(function()
                                desc.Text = data.translation
                                Engine.translatedElements[desc] = true
                                Engine.localizeCount = Engine.localizeCount + 1
                                localizedCount = localizedCount + 1
                            end)
                        end
                    end
                end
            end
            
            if localizedCount > 0 then
                print(string.format("çš®ç©ºç¿»è¯‘ - åº”ç”¨äº† %d ä¸ªç¿»è¯‘", localizedCount))
            end
            
            task.wait(RUNTIME.scanInterval)
        end
    end

    -- å¯åŠ¨ç¿»è¯‘æœåŠ¡
    local function startLocalization()
        if Engine.isRunning then 
            WindUI:Notify({
                Title = "çš®ç©ºç¿»è¯‘",
                Content = "ç¿»è¯‘æœåŠ¡å·²ç»åœ¨è¿è¡Œä¸­",
                Duration = 2
            })
            return 
        end
        
        Engine.isRunning = true
        WindUI:Notify({
            Title = "çš®ç©ºç¿»è¯‘",
            Content = "æ­£åœ¨å¯åŠ¨ç¿»è¯‘æœåŠ¡...",
            Duration = 2
        })
        
        -- åŠ è½½ç¼“å­˜
        if RUNTIME.CACHE_ENABLED then
            loadCacheFromFile()
        end
        
        -- å¼€å§‹æ‰«æ
        spawn(function()
            local total, new = scanAllGuiElements()
            
            -- å¯åŠ¨ç¿»è¯‘é˜Ÿåˆ—å¤„ç†
            spawn(function()
                while Engine.isRunning do
                    processTranslationQueue()
                    task.wait(0.5)
                end
            end)
            
            -- å¯åŠ¨æœ¬åœ°åŒ–åº”ç”¨
            spawn(applyLocalizations)
            
            WindUI:Notify({
                Title = "çš®ç©ºç¿»è¯‘",
                Content = string.format("ç¿»è¯‘æœåŠ¡å·²å¯åŠ¨ï¼å‘ç° %d ä¸ªå¾…ç¿»è¯‘æ–‡æœ¬", #Engine.translateQueue),
                Duration = 3
            })
        end)
    end

    -- åœæ­¢ç¿»è¯‘æœåŠ¡
    local function stopLocalization()
        if not Engine.isRunning then 
            WindUI:Notify({
                Title = "çš®ç©ºç¿»è¯‘",
                Content = "ç¿»è¯‘æœåŠ¡æœªåœ¨è¿è¡Œ",
                Duration = 2
            })
            return 
        end
        
        Engine.isRunning = false
        
        -- æ–­å¼€æ‰€æœ‰ç›‘æ§è¿æ¥
        for _, conn in ipairs(Engine.monitorConnections) do
            pcall(function() 
                if conn and conn.Disconnect then 
                    conn:Disconnect() 
                end 
            end)
        end
        Engine.monitorConnections = {}
        
        -- ä¿å­˜ç¼“å­˜
        if RUNTIME.CACHE_ENABLED then
            saveCacheToFile()
        end
        
        WindUI:Notify({
            Title = "çš®ç©ºç¿»è¯‘",
            Content = "ç¿»è¯‘æœåŠ¡å·²åœæ­¢",
            Duration = 2
        })
    end

    -- é‡ç½®ç¿»è¯‘çŠ¶æ€
    local function resetTranslation()
        stopLocalization()
        
        Engine.textData = {}
        Engine.scannedElements = {}
        Engine.translatedElements = {}
        Engine.translateQueue = {}
        Engine.queuedSet = {}
        Engine.extractCount = 0
        Engine.translateCount = 0
        Engine.localizeCount = 0
        Engine.totalElementsScanned = 0
        
        WindUI:Notify({
            Title = "çš®ç©ºç¿»è¯‘",
            Content = "ç¿»è¯‘çŠ¶æ€å·²é‡ç½®",
            Duration = 2
        })
    end

    -- ========== ç¿»è¯‘æ§åˆ¶æ ‡ç­¾é¡µ ==========
    Tabs.MainTab:Paragraph({
        Title = "çš®ç©ºAPIç¿»è¯‘",
        Desc = "é«˜çº§å¤šAPIç¿»è¯‘ç³»ç»Ÿ\næ”¯æŒå®æ—¶ç•Œé¢æ±‰åŒ–å’Œæ™ºèƒ½æ–‡æœ¬æ£€æµ‹",
        Image = "languages",
        ImageSize = 32,
        Color = Color3.fromHex("#FF6B6B")
    })

    -- ä¸»æ§åˆ¶æŒ‰é’®
    local mainToggle = Tabs.MainTab:Toggle({
        Title = "å¯åŠ¨ç¿»è¯‘æœåŠ¡",
        Desc = "å¼€å§‹æ‰«æå’Œç¿»è¯‘ç•Œé¢æ–‡æœ¬",
        Default = Engine.isRunning,
        Callback = function(state)
            if state then
                startLocalization()
            else
                stopLocalization()
            end
        end
    })

    Tabs.MainTab:Button({
        Title = "ç«‹å³æ‰«æç•Œé¢",
        Icon = "search",
        Callback = function()
            if Engine.isRunning then
                spawn(scanAllGuiElements)
            else
                WindUI:Notify({
                    Title = "çš®ç©ºç¿»è¯‘",
                    Content = "è¯·å…ˆå¯åŠ¨ç¿»è¯‘æœåŠ¡",
                    Duration = 3
                })
            end
        end
    })

    Tabs.MainTab:Button({
        Title = "å¼ºåˆ¶åº”ç”¨ç¿»è¯‘",
        Icon = "refresh-cw",
        Callback = function()
            if Engine.isRunning then
                spawn(applyLocalizations)
                WindUI:Notify({
                    Title = "çš®ç©ºç¿»è¯‘",
                    Content = "æ­£åœ¨å¼ºåˆ¶åº”ç”¨æ‰€æœ‰ç¿»è¯‘...",
                    Duration = 2
                })
            else
                WindUI:Notify({
                    Title = "çš®ç©ºç¿»è¯‘",
                    Content = "è¯·å…ˆå¯åŠ¨ç¿»è¯‘æœåŠ¡",
                    Duration = 3
                })
            end
        end
    })

    Tabs.MainTab:Divider()

    -- çŠ¶æ€æ˜¾ç¤º
    local statusText = string.format(
        "æœåŠ¡çŠ¶æ€: %s\nå½“å‰API: %s\næå–æ–‡æœ¬: %d\nå·²ç¿»è¯‘: %d\nå·²åº”ç”¨: %d\nå¾…ç¿»è¯‘: %d\næ€»æ‰«æ: %d",
        Engine.isRunning and "ğŸŸ¢ è¿è¡Œä¸­" or "ğŸ”´ å·²åœæ­¢",
        RUNTIME.translationAPI,
        Engine.extractCount,
        Engine.translateCount,
        Engine.localizeCount,
        #Engine.translateQueue,
        Engine.totalElementsScanned
    )

    Tabs.MainTab:Paragraph({
        Title = "å®æ—¶çŠ¶æ€",
        Desc = statusText,
        Image = "bar-chart",
        ImageSize = 20,
        Color = Color3.fromHex("#0078D7")
    })

    -- ========== APIè®¾ç½®æ ‡ç­¾é¡µ ==========
    Tabs.ConfigTab:Paragraph({
        Title = "APIè®¾ç½®",
        Desc = "é…ç½®ç¿»è¯‘APIå’ŒåŸºæœ¬å‚æ•°",
        Image = "settings",
        ImageSize = 24,
        Color = Color3.fromHex("#0078D7")
    })

    -- APIé€‰æ‹©
    local apiDropdown = Tabs.ConfigTab:Dropdown({
        Title = "ç¿»è¯‘API",
        Multi = false,
        AllowNone = false,
        Values = {"Google", "Baidu", "Tencent", "Custom"},
        Callback = function(api)
            RUNTIME.translationAPI = api
            WindUI:Notify({
                Title = "çš®ç©ºç¿»è¯‘",
                Content = "å·²åˆ‡æ¢åˆ° " .. api .. " API",
                Duration = 2
            })
        end
    })
    apiDropdown:Select(RUNTIME.translationAPI)

    -- è‡ªå®šä¹‰APIè®¾ç½®
    local customApiInput = Tabs.ConfigTab:Input({
        Title = "è‡ªå®šä¹‰API URL",
        PlaceholderText = "è¾“å…¥è‡ªå®šä¹‰ç¿»è¯‘API URLï¼Œä½¿ç”¨ {text} ä½œä¸ºæ–‡æœ¬å ä½ç¬¦",
        Value = RUNTIME.customAPIUrl,
        Callback = function(text)
            RUNTIME.customAPIUrl = text
        end
    })

    Tabs.ConfigTab:Divider()

    -- æ–‡æœ¬è¿‡æ»¤è®¾ç½®
    Tabs.ConfigTab:Paragraph({
        Title = "æ–‡æœ¬è¿‡æ»¤",
        Desc = "è®¾ç½®æ–‡æœ¬æ£€æµ‹å’Œè¿‡æ»¤è§„åˆ™",
        Image = "filter",
        ImageSize = 20,
        Color = Color3.fromHex("#FFA500")
    })

    local minLenSlider = Tabs.ConfigTab:Slider({
        Title = "æœ€å°æ–‡æœ¬é•¿åº¦",
        Value = {
            Min = 1,
            Max = 10,
            Default = RUNTIME.minTextLength,
        },
        Increment = 1,
        Callback = function(value)
            RUNTIME.minTextLength = value
        end
    })

    local maxLenSlider = Tabs.ConfigTab:Slider({
        Title = "æœ€å¤§æ–‡æœ¬é•¿åº¦",
        Value = {
            Min = 50,
            Max = 300,
            Default = RUNTIME.maxTextLength,
        },
        Increment = 10,
        Callback = function(value)
            RUNTIME.maxTextLength = value
        end
    })

    local excludeChineseToggle = Tabs.ConfigTab:Toggle({
        Title = "æ’é™¤ä¸­æ–‡æ–‡æœ¬",
        Desc = "ä¸ç¿»è¯‘å·²ç»æ˜¯ä¸­æ–‡çš„æ–‡æœ¬",
        Default = RUNTIME.excludeChinese,
        Callback = function(state)
            RUNTIME.excludeChinese = state
        end
    })

    -- ========== é«˜çº§åŠŸèƒ½æ ‡ç­¾é¡µ ==========
    Tabs.AdvancedTab:Paragraph({
        Title = "é«˜çº§è®¾ç½®",
        Desc = "æ€§èƒ½è°ƒä¼˜å’Œé«˜çº§åŠŸèƒ½é…ç½®",
        Image = "zap",
        ImageSize = 24,
        Color = Color3.fromHex("#9B59B6")
    })

    -- æ€§èƒ½è®¾ç½®
    local tpsSlider = Tabs.AdvancedTab:Slider({
        Title = "æ¯ç§’ç¿»è¯‘æ•°",
        Desc = "æ§åˆ¶ç¿»è¯‘é€Ÿåº¦ï¼Œå€¼è¶Šé«˜ç¿»è¯‘è¶Šå¿«ä½†å¯èƒ½è¢«é™åˆ¶",
        Value = {
            Min = 5,
            Max = 50,
            Default = RUNTIME.translationsPerSecond,
        },
        Increment = 1,
        Callback = function(value)
            RUNTIME.translationsPerSecond = value
        end
    })

    local batchSlider = Tabs.AdvancedTab:Slider({
        Title = "æ‰¹å¤„ç†å¤§å°",
        Desc = "æ¯æ¬¡æ‰¹é‡ç¿»è¯‘çš„æ–‡æœ¬æ•°é‡",
        Value = {
            Min = 1,
            Max = 20,
            Default = RUNTIME.batchSize,
        },
        Increment = 1,
        Callback = function(value)
            RUNTIME.batchSize = value
        end
    })

    local scanSlider = Tabs.AdvancedTab:Slider({
        Title = "æ‰«æé—´éš”(ç§’)",
        Desc = "é‡æ–°æ‰«æç•Œé¢å’Œåº”ç”¨ç¿»è¯‘çš„æ—¶é—´é—´éš”",
        Value = {
            Min = 1,
            Max = 10,
            Default = RUNTIME.scanInterval,
        },
        Increment = 1,
        Callback = function(value)
            RUNTIME.scanInterval = value
        end
    })

    Tabs.AdvancedTab:Divider()

    -- ç¼“å­˜è®¾ç½®
    Tabs.AdvancedTab:Paragraph({
        Title = "ç¼“å­˜ç®¡ç†",
        Desc = "ç¿»è¯‘ç»“æœç¼“å­˜è®¾ç½®",
        Image = "database",
        ImageSize = 20,
        Color = Color3.fromHex("#27AE60")
    })

    local cacheToggle = Tabs.AdvancedTab:Toggle({
        Title = "å¯ç”¨ç¿»è¯‘ç¼“å­˜",
        Desc = "ç¼“å­˜ç¿»è¯‘ç»“æœæé«˜æ€§èƒ½",
        Default = RUNTIME.CACHE_ENABLED,
        Callback = function(state)
            RUNTIME.CACHE_ENABLED = state
            if not state then
                clearCache()
            end
        end
    })

    Tabs.AdvancedTab:Button({
        Title = "æ¸…ç©ºç¿»è¯‘ç¼“å­˜",
        Icon = "trash-2",
        Callback = function()
            clearCache()
        end
    })

    Tabs.AdvancedTab:Button({
        Title = "é‡ç½®ç¿»è¯‘çŠ¶æ€",
        Icon = "refresh-cw",
        Callback = function()
            resetTranslation()
        end
    })

    -- ========== ç³»ç»Ÿä¿¡æ¯æ ‡ç­¾é¡µ ==========
    Tabs.InfoTab:Paragraph({
        Title = "ç³»ç»Ÿä¿¡æ¯",
        Desc = "çš®ç©ºAPIç¿»è¯‘ - ç‰ˆæœ¬ 1.0.0",
        Image = "info",
        ImageSize = 24,
        Color = Color3.fromHex("#3498DB")
    })

    -- ç³»ç»ŸçŠ¶æ€
    local systemInfo = string.format(
        "æ³¨å…¥å™¨: %s\næ¸¸æˆ: %s\nç©å®¶: %s\nè¿è¡Œæ—¶é—´: %s",
        identifyexecutor() or "æœªçŸ¥",
        game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name or "æœªçŸ¥",
        Players.LocalPlayer.Name,
        "åˆšåˆšå¯åŠ¨"
    )

    Tabs.InfoTab:Paragraph({
        Title = "è¿è¡Œç¯å¢ƒ",
        Desc = systemInfo,
        Image = "cpu",
        ImageSize = 20,
        Color = Color3.fromHex("#95A5A6")
    })

    Tabs.InfoTab:Divider()

    -- ä½¿ç”¨è¯´æ˜
    Tabs.InfoTab:Paragraph({
        Title = "ä½¿ç”¨è¯´æ˜",
        Desc = "1. åœ¨'ç¿»è¯‘æ§åˆ¶'ä¸­å¯åŠ¨æœåŠ¡\n2. åœ¨'APIè®¾ç½®'ä¸­é€‰æ‹©ç¿»è¯‘API\n3. åœ¨'é«˜çº§è®¾ç½®'ä¸­è°ƒæ•´æ€§èƒ½å‚æ•°\n4. ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰«æå¹¶ç¿»è¯‘ç•Œé¢æ–‡æœ¬",
        Image = "book-open",
        ImageSize = 20,
        Color = Color3.fromHex("#F39C12")
    })

    Tabs.InfoTab:Divider()

    -- å…³äºä¿¡æ¯
    Tabs.InfoTab:Paragraph({
        Title = "å…³äºçš®ç©ºAPIç¿»è¯‘",
        Desc = "é«˜çº§ç¿»è¯‘ç³»ç»Ÿ\næ”¯æŒå¤šAPIã€å®æ—¶ç›‘æ§ã€æ™ºèƒ½ç¼“å­˜\nä½œè€…: çš®ç©ºå›¢é˜Ÿ",
        Image = "user",
        ImageSize = 20,
        Color = Color3.fromHex("#E74C3C"),
        Buttons = {
            {
                Title = "å¤åˆ¶è”ç³»æ–¹å¼",
                Icon = "copy",
                Variant = "Tertiary",
                Callback = function()
                    setclipboard("çš®ç©ºç¿»è¯‘ - QQç¾¤: 1057315887")
                    WindUI:Notify({
                        Title = "çš®ç©ºç¿»è¯‘", 
                        Content = "è”ç³»æ–¹å¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",
                        Duration = 2
                    })
                end
            }
        }
    })

    -- è‡ªåŠ¨å¯åŠ¨ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    if RUNTIME.autoStart then
        spawn(function()
            wait(2)
            startLocalization()
        end)
    end

    -- å®æ—¶çŠ¶æ€æ›´æ–°
    local statsUpdateConnection
    statsUpdateConnection = RunService.Heartbeat:Connect(function()
        if not Engine then return end
        
        local currentStatus = string.format(
            "æœåŠ¡çŠ¶æ€: %s\nå½“å‰API: %s\næå–æ–‡æœ¬: %d\nå·²ç¿»è¯‘: %d\nå·²åº”ç”¨: %d\nå¾…ç¿»è¯‘: %d\næ€»æ‰«æ: %d",
            Engine.isRunning and "ğŸŸ¢ è¿è¡Œä¸­" or "ğŸ”´ å·²åœæ­¢",
            RUNTIME.translationAPI,
            Engine.extractCount,
            Engine.translateCount,
            Engine.localizeCount,
            #Engine.translateQueue,
            Engine.totalElementsScanned
        )
        
        -- è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶æ›´æ–°UIçš„é€»è¾‘
    end)

    -- çª—å£å…³é—­æ—¶çš„å¤„ç†
    Window:OnClose(function()
        print("çš®ç©ºAPIç¿»è¯‘ - çª—å£å·²å…³é—­")
        if statsUpdateConnection then
            statsUpdateConnection:Disconnect()
        end
        stopLocalization()
    end)

    print("çš®ç©ºAPIç¿»è¯‘ - ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼")
    WindUI:Notify({
        Title = "çš®ç©ºAPIç¿»è¯‘",
        Content = "ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨",
        Duration = 3
    })
end

-- ç›´æ¥å¯åŠ¨
initTranslationScript()
